<!DOCTYPE html>
<html lang="en">

  <head>
   
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Malware Checker</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <style>
      body {
        padding-top: 54px;
      }
      @media (min-width: 992px) {
        body {
          padding-top: 56px;
        }
      }

    </style>
    <script>
      function validate(form) {
        
        fail = validateUsername(form.username.value);
        fail += validatePassword(form.password.value);
        if (fail == "") {
          return true;
        } else {
          return false;
        }

        
        
        
      }

      function validateUsername(field){
        if (field == "") 
          return "No Username was entered.\n" 
        else if (field.length < 5)
          return "Usernames must be at least 5 characters.\n" 
        else if (/[^a-zA-Z0-9_-]/.test(field))
          return "Only a-z, A-Z, 0-9, - and _ allowed in Usernames.\n"
        return "";

      }

      function validatePassword(field) {
        if (field =="") {
          return "No password was entered.\n"
        } else if (field.length < 6) {
          return "Password must be at least 7 characters.\n"
        } else if (!/[a-z]/.test(field) || ! /[A-Z]/.test(field) || !/[0-9]/.test(field)) {
          return "Password require at least one a-z,A-Z, and 0-9. \n"
        }
        return "";
      }
    </script>
  </head>

  <body>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
      <div class="container">
        <a class="navbar-brand" href="#">Malware File Scanner</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto">
            <li class="nav-item active">
              <a class="nav-link" href="index.php">User Login
                <span class="sr-only">(current)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="upload.php">Upload File</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="container">
      <div class="row">
        <div class="col-lg-12 text-center">
          <h1 class="mt-5">Login</h1>
          <p class="lead">Login here as ADMIN</p>
            <form action="index.php" method="post" onsubmit="return validate(this)">
              Username:<br>
              <input type="text" name="username"><br>
              Password:<br>
              <input type="password" name="password"><br><br>
              <input type="submit" value="Login">
            </form>
            <?php

                function validate() {
                  $username = "";
                  $password = "";

                  if (isset($_POST['username'])) {
                      $username = fix_string($_POST['username']);
                  }

                  if(isset($_POST['password'])) {
                      $password = fix_string($_POST['password']);
                  }

                  $fail = validate_username($username);
                  $fail .= validate_password($password);
                }
                
                function validate_password($field) {
                  if ($field == "") {
                    return "No password<br>";
                  } else if (strlen($field) < 6) {
                    return "Password must be at least 6<br>";
                  } else if (!preg_match("/[a-z]/", $field) || !preg_match("/[A-Z]/", $field) || !preg_match("/[0-9]/", $field)) {
                    return "Password requires 1 each of a-z, A-Z, 0-9<br>";
                  }
                    return "";
                }

                function validate_username($field) {
                  if ($field == "") {
                    return "No username entered<br>";
                  } else if ($field < 4) {
                    return "username must be at least 5 letters<br>";
                  } else if (preg_match("/[^a-zA-Z0-9_-]/",$field)) {
                    return "username must contain a-z,A-Z, 0-9<br>";
                  }
                  return "";
                }

                function fix_string($string) {
                  if (get_magic_quotes_gpc()) {
                    $string = stripcslashes($string);
                    
                  }
                  return htmlentities($string);
                }

            ?>

            <?php
                require_once 'connection.php';
                $conn = new mysqli($hn,$un,$pw,$db);

                if ($conn->connect_error) die ($conn->connect_error);
                if (isset($_POST['username']) && isset($_POST['password'])) {
                  $user = mysql_entities_fix_string($conn,$_POST['username']);
                  $pass = mysql_entities_fix_string($conn,$_POST['password']);
                }

                function mysql_entities_fix_string($conn, $string) {
                  return htmlentities(mysql_fix_string($conn, $string));
                }

                function mysql_fix_string($conn, $string) {
                  if (get_magic_quotes_gpc()) {
                    stripcslashes($string);
                  }
                  return $conn->real_escape_string($string);
                }
            ?> 

            <?php //authenticate2
              require_once 'connection.php';
              $conn = new mysqli($hn,$un,$pw,$db);
              if ($conn->connect_error) die ($conn->connect_error);
              if (isset($_POST['username']) && isset($_POST['password'])) {
                $tempUser = mysql_entities_fix_string($conn,$_POST['username']);
                $tempPw = mysql_entities_fix_string($conn,$_POST['password']);
                $query = "SELECT username, password FROM users WHERE username = '$tempUser' AND password = '$tempPw'";
                $result = $conn->query($query);

              }
              
            ?>

            <?php //setupusers.php
              require_once 'connection.php';
              $connection = new mysqli($hn, $un, $pw, $db); 
              if ($connection->connect_error) die($connection->connect_error);
              
              $query = "CREATE TABLE users (
                firstname VARCHAR(32) NOT NULL,
                lastname VARCHAR(32) NOT NULL,
                username VARCHAR(32) NOT NULL UNIQUE,
                password VARCHAR(32) NOT NULL
              )";

              //$result = $connection->query($query);
              $queryCheck = "SELECT 1 FROM users";
              if (!$connection->query($queryCheck)) {
                $result = $connection->query($query);
              }
              
              $salt1 = "qm&h*";
              $salt2 = "pg!@";
              //Based on my standards of username & password. It is regulated for the username to be at least 4 characters long and must contain only letters a-z, A-Z, 0-9. underscore, and hyphens. Password requires both Uppercase and lowercase letters as well as at least 1 number. 
              $forename = 'Bill';
              $surname = 'Smith';
              $username = 'bsmith';
              $password = 'Mysecret123';

              $token = hash('ripemd128', "$salt1$password$salt2");

              add_user($connection, $forename, $surname, $username, $token);

              $forename = 'Pauline';
              $surname = 'Jones';
              $username = 'pjones';
              $password = 'Acrobat294';

              $token = hash('ripemd128', "$salt1$password$salt2");

              add_user($connection, $forename, $surname, $username, $token);


              function add_user($connection, $fn, $sn, $un, $pw) 
              {
                  $query1 = "INSERT IGNORE INTO users VALUES ('$fn', '$sn', '$un', '$pw')";
                  $result = $connection->query($query1);
                  if (!$result) die($connection->error);
                
              }


            ?>
            <?php

              require_once 'connection.php';
              $connection = new mysqli($hn, $un, $pw, $db);
              if ($connection->connect_error) die($connection->connect_error);
              if (isset($_POST['username']) && isset($_POST['password']))
              {

                  $un_temp = mysql_entities_fix_string($connection, $_POST['username']);
                  $pw_temp = mysql_entities_fix_string($connection, $_POST['password']);
                  $query = "SELECT * FROM users WHERE username = '$un_temp'";
                  $result = $connection->query($query);
                  if (!$result) die ($connection->error);
                  elseif ($result->num_rows) {
                    $row = $result->fetch_array(MYSQLI_NUM);
                    $result->close();
                    $salt1 = "qm&h*";
                    $salt2 = "pg!@";
                    $token = hash('ripemd128', "$salt1$pw_temp$salt2");
                    
                    if ($token == $row[3]) {
                      session_start();
                      $_SESSION['username'] = $un_temp;
                      $_SESSION['password'] = $pw_temp;
                      echo "$row[0] $row[1]: Hi $row[0] you are now logged in as '$row[2]'"; 
                      die ("<p><a href=adminUpload.php>Click here to continue</a></p>");

                    } else {
                      die("Invalid username and password");
                    }
                    
                    

                 }
                  
              }
              $connection->close();
            ?>


            
          <ul class="list-unstyled">
          </ul>
        </div>
      </div>
    </div>


    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    

  </body>

</html>
